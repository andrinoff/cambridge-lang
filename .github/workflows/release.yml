name: Release Pipeline

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: "Version Bump Type (major, minor, patch)"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed for release notes generation

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-wasip1

      - name: Configure Git User
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Bump Version Everywhere
        id: bump_version
        run: |
          # 1. Read current version from VERSION file (source of truth)
          if [ -f VERSION ]; then
            CURRENT_VERSION=$(cat VERSION | tr -d '[:space:]')
          else
            CURRENT_VERSION="0.0.0"
          fi

          IFS='.' read -r -a parts <<< "$CURRENT_VERSION"
          major=${parts[0]}
          minor=${parts[1]}
          patch=${parts[2]}

          # 2. Calculate New Version
          BUMP_TYPE="${{ inputs.bump_type }}"
          if [ "$BUMP_TYPE" == "major" ]; then
            major=$((major + 1)); minor=0; patch=0
          elif [ "$BUMP_TYPE" == "minor" ]; then
            minor=$((minor + 1)); patch=0
          else
            patch=$((patch + 1))
          fi
          NEW_VERSION="$major.$minor.$patch"
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          echo "PREVIOUS_VERSION=$CURRENT_VERSION" >> $GITHUB_ENV

          echo "Bumping version from $CURRENT_VERSION to $NEW_VERSION"

          # =======================================================
          # 3. UPDATE ALL VERSION FILES
          # =======================================================

          # A. Source of Truth
          echo "$NEW_VERSION" > VERSION

          # B. VS Code Extension (package.json)
          tmp=$(mktemp)
          jq --arg v "$NEW_VERSION" '.version = $v' editors/vscode/package.json > "$tmp" && mv "$tmp" editors/vscode/package.json

          # C. Zed Extension Metadata (extension.toml)
          sed -i "s/^version = \".*\"/version = \"$NEW_VERSION\"/" editors/zed/extension.toml

          # D. Zed Extension Cargo.toml
          sed -i "s/^version = \".*\"/version = \"$NEW_VERSION\"/" editors/zed/Cargo.toml

          # E. Zed Rust Code (lib.rs) - Update download URLs
          sed -i "s|releases/download/v[0-9]*\.[0-9]*\.[0-9]*|releases/download/v$NEW_VERSION|g" editors/zed/src/lib.rs

          # F. Zed Extension grammar rev (extension.toml) - Update to new tag
          sed -i "s/^rev = \".*\"/rev = \"v$NEW_VERSION\"/" editors/zed/extension.toml

          # G. Makefile
          sed -i "s/^VERSION=.*/VERSION=$NEW_VERSION/" Makefile

          # H. Go CLI (main.go)
          sed -i "s/const VERSION = \".*\"/const VERSION = \"$NEW_VERSION\"/" cmd/cambridge/main.go

          # I. Tree-sitter grammar (package.json)
          tmp=$(mktemp)
          jq --arg v "$NEW_VERSION" '.version = $v' tree-sitter-cambridge/package.json > "$tmp" && mv "$tmp" tree-sitter-cambridge/package.json

          # J. Tree-sitter grammar Cargo.toml
          sed -i "0,/^version = \".*\"/s//version = \"$NEW_VERSION\"/" tree-sitter-cambridge/Cargo.toml

      # --- 4. COMPILE GO BINARIES ---
      # Binary names must match what Zed extension expects in lib.rs
      - name: Build Go Binaries
        run: |
          mkdir -p build_assets

          echo "Building cambridge-lsp-linux..."
          GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o build_assets/cambridge-lsp-linux ./cmd/cambridge-lsp

          echo "Building cambridge-lsp-macos-intel..."
          GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o build_assets/cambridge-lsp-macos-intel ./cmd/cambridge-lsp

          echo "Building cambridge-lsp-macos-arm64..."
          GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o build_assets/cambridge-lsp-macos-arm64 ./cmd/cambridge-lsp

          echo "Building cambridge-lsp.exe..."
          GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o build_assets/cambridge-lsp.exe ./cmd/cambridge-lsp

          echo "Building cambridge CLI binaries..."
          GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o build_assets/cambridge-linux-amd64 ./cmd/cambridge
          GOOS=linux GOARCH=arm64 go build -ldflags="-s -w" -o build_assets/cambridge-linux-arm64 ./cmd/cambridge
          GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o build_assets/cambridge-macos-intel ./cmd/cambridge
          GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o build_assets/cambridge-macos-arm64 ./cmd/cambridge
          GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o build_assets/cambridge-windows.exe ./cmd/cambridge

      # --- 5. PACKAGE VS CODE EXTENSION ---
      - name: Package VS Code Extension
        working-directory: ./editors/vscode
        run: |
          npm install
          npm install -g @vscode/vsce
          vsce package --out ../../build_assets/cambridge-vscode-${{ env.NEW_VERSION }}.vsix

      # --- 6. PACKAGE ZED EXTENSION ---
      - name: Package Zed Extension
        working-directory: ./editors/zed
        run: |
          cargo build --release --target wasm32-wasip1
          mkdir -p ../../build_assets/zed-extension
          cp target/wasm32-wasip1/release/cambridge_pseudo.wasm ../../build_assets/zed-extension/extension.wasm
          cp extension.toml ../../build_assets/zed-extension/
          cp -r languages ../../build_assets/zed-extension/
          cd ../../build_assets
          zip -r cambridge-zed-${{ env.NEW_VERSION }}.zip zed-extension
          rm -rf zed-extension

      # --- 7. COMMIT & TAG ---
      - name: Commit and Push Version Bump
        run: |
          git add -A
          git commit -m "chore: release v${{ env.NEW_VERSION }} [skip ci]"
          git tag "v${{ env.NEW_VERSION }}"
          git push origin HEAD --tags

      # --- 8. GITHUB RELEASE WITH AUTO-GENERATED NOTES ---
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.NEW_VERSION }}
          name: Release v${{ env.NEW_VERSION }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            build_assets/cambridge-lsp-linux
            build_assets/cambridge-lsp-macos-intel
            build_assets/cambridge-lsp-macos-arm64
            build_assets/cambridge-lsp.exe
            build_assets/cambridge-linux-amd64
            build_assets/cambridge-linux-arm64
            build_assets/cambridge-macos-intel
            build_assets/cambridge-macos-arm64
            build_assets/cambridge-windows.exe
            build_assets/cambridge-vscode-${{ env.NEW_VERSION }}.vsix
            build_assets/cambridge-zed-${{ env.NEW_VERSION }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # --- 9. PUBLISH TO VS CODE MARKETPLACE ---
      - name: Publish to VS Code Marketplace
        working-directory: ./editors/vscode
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: |
          if [ -n "$VSCE_PAT" ]; then
            echo "Publishing to VS Code Marketplace..."
            vsce publish -p $VSCE_PAT
          else
            echo "VSCE_PAT not set, skipping VS Code Marketplace publish"
          fi
